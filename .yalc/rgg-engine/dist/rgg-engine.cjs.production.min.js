"use strict";function e(e){return e&&"object"==typeof e&&"default"in e?e.default:e}Object.defineProperty(exports,"__esModule",{value:!0});var t,n=require("react-nil"),r=require("react"),o=e(r),a=require("three"),i=e(require("zustand")),s=require("planck-js"),u=require("react-three-fiber"),c=require("cannon-es"),d=require("@dimforge/rapier3d-compat/rapier.js"),l=r.createContext(null),f=Date.now(),p=function(){return f+performance.now()};!function(e){e[e.PHYSICS_UPDATE=0]="PHYSICS_UPDATE",e[e.PHYSICS_PROCESSED=1]="PHYSICS_PROCESSED",e[e.PHYSICS_READY=2]="PHYSICS_READY",e[e.PHYSICS_SET_PAUSED=3]="PHYSICS_SET_PAUSED",e[e.PHYSICS_ACKNOWLEDGED=4]="PHYSICS_ACKNOWLEDGED",e[e.ADD_BODY=5]="ADD_BODY",e[e.REMOVE_BODY=6]="REMOVE_BODY",e[e.MODIFY_BODY=7]="MODIFY_BODY",e[e.CUSTOM=8]="CUSTOM"}(t||(t={}));var y=r.createContext(null),v=function(){return r.useContext(y)};function m(e,t,n,r,o,a,i){try{var s=e[a](i),u=s.value}catch(e){return void n(e)}s.done?t(u):Promise.resolve(u).then(r,o)}function h(e){return function(){var t=this,n=arguments;return new Promise((function(r,o){var a=e.apply(t,n);function i(e){m(a,r,o,i,s,"next",e)}function s(e){m(a,r,o,i,s,"throw",e)}i(void 0)}))}}function g(){return(g=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e}).apply(this,arguments)}function b(e,t){return(b=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function w(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}function S(e,t,n){return(S=w()?Reflect.construct:function(e,t,n){var r=[null];r.push.apply(r,t);var o=new(Function.bind.apply(e,r));return n&&b(o,n.prototype),o}).apply(null,arguments)}function E(e,t){if(null==e)return{};var n,r,o={},a=Object.keys(e);for(r=0;r<a.length;r++)t.indexOf(n=a[r])>=0||(o[n]=e[n]);return o}var B,x=a.MathUtils.generateUUID,O=i((function(){return{activeKeys:{}}})),C={},k=function(e,t){return C[e]=t,O.setState((function(n){var r;return{activeKeys:g({},n.activeKeys,(r={},r[e]=t,r))}}))};!function(e){e.mounted="mounted",e.unmounted="unmounted",e.propUpdate="propUpdate",e.propRemoved="propRemoved"}(B||(B={}));var P,D=function(e){var t=e.propKey,n=e.id,o=e.value,a=e.sendMessage,i=r.useRef(!0);return r.useEffect((function(){i.current?i.current=!1:a({message:B.propUpdate,id:n,value:o,propKey:t})}),[o,n,t]),r.useEffect((function(){return function(){a({message:B.propRemoved,id:n,propKey:t})}}),[n,t]),null},R=r.createContext(null),_=function(e){var n=e.worker,a=e.children,i=r.useCallback((function(e){n.postMessage({type:t.CUSTOM,message:e})}),[n]);return function(e){r.useEffect((function(){var t=e.onmessage;return e.onmessage=function(e){t&&t(e);var n=e.data;switch(n.type){case"KEYUP":k(n.data.keyCode,!1);break;case"KEYDOWN":k(n.data.keyCode,!0)}},function(){e.onmessage=t}}),[e])}(n),o.createElement(R.Provider,{value:{sendMessage:i,worker:n}},a)},M=r.createContext(null),U=function(){return r.useContext(M)},A=function(e){var t=e.children,n=r.useRef({subscriptionsIterator:0}),a=r.useRef({}),i=r.useMemo((function(){return{subscribeToOnPhysicsUpdate:function(e){var t=n.current.subscriptionsIterator.toString();return n.current.subscriptionsIterator+=1,a.current[t]=e,function(){delete a.current[t]}},updateSubscriptions:function(e){Object.values(a.current).forEach((function(t){return t.current(e)}))}}}),[]);return o.createElement(M.Provider,{value:{onFixedUpdateSubscriptions:a,subscribeToOnPhysicsUpdate:i.subscribeToOnPhysicsUpdate,updateSubscriptions:i.updateSubscriptions}},t)},I=function(e){var n=e.paused,a=void 0!==n&&n,i=e.updateBodyData,s=e.worker,u=e.children,c=e.stepRate,d=void 0===c?1e3/60:c,l=e.lerpBody,f=r.useState(!1),v=f[0],m=f[1],h=r.useState({})[0],g=r.useRef({lastUpdate:p(),subscriptionsIterator:0,bodies:[]}),b=U().updateSubscriptions,w=r.useRef({}),S=r.useCallback((function(e,t){t.current&&l(e,t.current,d)}),[]),E=r.useCallback((function(e,t,n,r){r&&(g.current.bodies=r),Object.entries(h).forEach((function(o){var a=o[1];r&&(a.index=r.indexOf(o[0])),a.index>=0&&(i(a,t,n),a.lastUpdate=e)}));var o=(e-g.current.lastUpdate)/1e3;g.current.lastUpdate=e,b(o)}),[b]);r.useEffect((function(){if(!v){var e=setInterval((function(){s.postMessage({type:t.PHYSICS_READY,paused:a})}),200);return function(){clearInterval(e)}}}),[v,a]),r.useEffect((function(){s.postMessage({type:t.PHYSICS_SET_PAUSED,paused:a})}),[a]),r.useEffect((function(){var e=s.onmessage;s.onmessage=function(n){var r=n.data;switch(r.type){case t.PHYSICS_ACKNOWLEDGED:m(!0);break;case t.PHYSICS_UPDATE:E(r.updateTime,r.positions,r.angles,r.bodies),s.postMessage({type:t.PHYSICS_PROCESSED,positions:r.positions,angles:r.angles},[r.positions.buffer,r.angles.buffer])}e&&e(n)}}),[]);var B=r.useMemo((function(){return{syncBody:function(e,t,n){void 0===n&&(n=!0),g.current.subscriptionsIterator+=1;var r={ref:t,index:g.current.bodies.indexOf(e),lastUpdate:p(),lastRender:p(),previous:{},applyRotation:n};return h[e]=r,w.current[e]=function(){return S(r,t)},function(){delete w.current[e],delete h[e]}}}}),[]).syncBody,x=r.useCallback((function(){Object.values(w.current).forEach((function(e){return e()}))}),[]),O=r.useCallback((function(e){s.postMessage(e)}),[]);return function(e){r.useEffect((function(){var t=function(t){t.repeat||e.postMessage({type:"KEYDOWN",data:{code:t.code,key:t.key,keyCode:t.keyCode}})},n=function(t){e.postMessage({type:"KEYUP",data:{code:t.code,key:t.key,keyCode:t.keyCode}})};return window.addEventListener("keydown",t),window.addEventListener("keyup",n),function(){window.removeEventListener("keydown",t),window.removeEventListener("keyup",n)}}),[])}(s),v?o.createElement(_,{worker:s},o.createElement(y.Provider,{value:{syncBody:B,syncMeshes:x,sendMessage:O}},o.createElement(re,{useRAF:!0}),u)):null},Y=function(e){return o.createElement(A,null,o.createElement(I,Object.assign({},e)))},L=0,j=0,N=function(e){var t,n,a,i,s,u,c=e.children;return t=e.onWorldStep,n=e.stepRate,a=r.useRef({lastUpdate:p()}),i=U().updateSubscriptions,s=r.useMemo((function(){return{stepWorld:function(){L=p(),j=L-a.current.lastUpdate,a.current.lastUpdate=L,t(j),i(j/1e3)}}}),[!1,t,i]).stepWorld,u=r.useRef(s),r.useEffect((function(){u.current=s}),[s]),r.useEffect((function(){(function(e){return new Worker("data:application/javascript,"+encodeURIComponent("\n            \n            var start = performance.now();\n            var updateRate = "+e+";\n            var maxAccumulator = updateRate;\n            \n            function getNow() {\n                return start + performance.now();\n            }\n            \n            var accumulator = 0;\n            var lastAccumulation = getNow();\n            var now = getNow();\n            var numberOfUpdates = 0;\n            \n            function accumulate() {\n                now = getNow();\n                accumulator += now - lastAccumulation;\n                lastAccumulation = now;\n                while (accumulator <= maxAccumulator) {\n                    now = getNow();\n                    accumulator += now - lastAccumulation;\n                    lastAccumulation = now;\n                }\n                numberOfUpdates = Math.floor(accumulator / maxAccumulator);\n                for (var i = 0; i < numberOfUpdates; i++) {\n                    self.postMessage('step');\n                    accumulator -= maxAccumulator;\n                }\n            }\n        \n            function step() {\n                \n                accumulate();\n                \n                setTimeout(step, updateRate - 2 - accumulator);\n                \n            }\n            \n            step()\n            \n        "))}(n)).onmessage=function(e){"step"===e.data&&u.current()}}),[u]),o.createElement(l.Provider,{value:{}},c)},F=function(e){var t=e.stepRate;return o.createElement(A,null,o.createElement(N,{onWorldStep:e.onWorldStep,stepRate:void 0===t?1e3/60:t},e.children))},T=r.createContext(null),W=r.createContext(null),q=function(){return r.useContext(W)},H=function(e){var n=e.worker,o=e.subscribe,a=e.applyBufferData,i=e.generateBuffers,s=e.setPaused,u=r.useContext(T),c=u.getPendingSyncedBodiesIteration,d=u.syncedBodies,l=u.syncedBodiesOrder,f=u.maxNumberOfSyncedBodies,y=r.useState((function(){return i(f)}))[0],v=r.useRef({lastUpdate:-1,bodiesIteration:-1}),m=r.useState(!1),h=m[0],g=m[1],b=r.useState(0),w=b[0],S=b[1],E=r.useCallback((function(e){v.current.lastUpdate=e,g(!1);var r=c(),o=r!==v.current.bodiesIteration;a(y,d,l);var i=y.positions,s=y.angles,u={type:t.PHYSICS_UPDATE,updateTime:p(),positions:i,angles:s};o&&(u.bodies=l,v.current.bodiesIteration=r),n.postMessage(u,[i.buffer,s.buffer])}),[c,d,l]),B=r.useRef(E);r.useEffect((function(){B.current=E}),[E]),r.useEffect((function(){h&&(w<=v.current.lastUpdate||B.current(w))}),[w,h]);var x=r.useCallback((function(){S((function(e){return e+1}))}),[]),O=r.useRef(x);return r.useEffect((function(){O.current=x}),[x]),r.useEffect((function(){return o((function(){return O.current()}))}),[]),r.useEffect((function(){var e=n.onmessage;n.onmessage=function(r){var o=r.data;switch(o.type){case t.PHYSICS_PROCESSED:y.positions=o.positions,y.angles=o.angles,g(!0);break;case t.PHYSICS_SET_PAUSED:var a;s&&s(null!=(a=o.paused)&&a);break;case t.PHYSICS_READY:var i;s&&s(null!=(i=o.paused)&&i),g(!0),n.postMessage({type:t.PHYSICS_ACKNOWLEDGED})}e&&e(r)}}),[]),null};(P=exports.FixtureShape||(exports.FixtureShape={})).Circle="Circle",P.Box="Box";var K,z=function(e){var n=e.world,o=e.worker,a=q(),i=a.addBody,u=a.bodies,c=r.useMemo((function(){return{handleModifyBody:function(e){var t=e.id,n=u[t];n?n[e.method].apply(n,e.args):console.warn("No body found matching "+t)},handleAddBody:function(e){var t=e.id,r=e.props,o=e.synced,a=function(e,t,n){var r=e.createBody(t);return n.forEach((function(e){var t=e.fixtureOptions,n=function(e,t){switch(e){case exports.FixtureShape.Circle:return s.Circle.apply(void 0,t);case exports.FixtureShape.Box:return s.Box.apply(void 0,t)}return null}(e.shape,e.args);n&&r.createFixture(n,t)})),r}(n,r.body,r.fixtures);i(t,a,o)}}}),[]),d=c.handleAddBody,l=c.handleModifyBody;return r.useEffect((function(){var e=o.onmessage;o.onmessage=function(n){var r=n.data;switch(r.type){case t.ADD_BODY:d(r.data);break;case t.MODIFY_BODY:l(r.data)}e&&e(n)}}),[]),null},G=a.MathUtils.lerp,V=function(e,t,n){var r=e.position,o=e.angle,a=e.lastUpdate,i=e.previous,s=e.applyRotation,u=void 0===s||s;if(r&&null!=o){if(!i.position||!i.angle)return t.position.x=r[0],t.position.z=r[1],void(u&&(t.rotation.z=o));var c=(p()-a)/(a+n+1-a),d=c=c<0?0:c>1?1:c;t.position.x=G(i.position[0],r[0],d),t.position.y=G(i.position[1],r[1],d),u&&(t.rotation.z=o)}},Q=function(e,t,n){e.previous.position=e.position,e.previous.angle=e.angle;var r=function(e,t){if(void 0!==t&&e.positions.length&&e.angles.length){var n=2*t;return{position:e.positions.slice(n,n+2),angle:e.angles[t]}}return null}({positions:t,angles:n},e.index);r&&(e.position=r.position,e.angle=r.angle)},J=function(e,t,n){var r=e.positions,o=e.angles;n.forEach((function(e,n){var a=t[e];if(a){var i=a.getPosition(),s=a.getAngle();r[2*n+0]=i.x,r[2*n+1]=i.y,o[n]=s}}))},X=function(e,t){t.body.position&&(e.position.x=t.body.position.x,e.position.z=t.body.position.y),t.body.angle&&(e.rotation.z=t.body.angle)},Z=function(e){return{positions:new Float32Array(2*e),angles:new Float32Array(e)}},$=function(e){void 0===e&&(e=function(){});var t,n,o,a=function(e){var t=r.useState({})[0],n=r.useState({})[0],o=r.useState([])[0],a=r.useRef(0),i=r.useCallback((function(){return a.current}),[]),s=r.useCallback((function(e,t){return o.push(e),n[e]=t,a.current+=1,function(){var t=o.indexOf(e);o.splice(t,1),delete n[e],a.current+=1}}),[]),u=r.useCallback((function(e){var t=o.indexOf(e);o.splice(t,1),delete n[e],a.current+=1}),[]),c=r.useCallback((function(n,r,o){var a;return void 0===o&&(o=!1),t[n]=r,o&&(a=s(n,r)),function(){delete t[n],a&&a(),e&&e(r)}}),[]);return{addSyncedBody:s,removeSyncedBody:u,getPendingSyncedBodiesIteration:i,syncedBodiesOrder:o,syncedBodies:n,addBody:c,bodies:t}}(e),i=a.addSyncedBody,s=a.removeSyncedBody,u=a.getPendingSyncedBodiesIteration,c=a.syncedBodies,d=a.syncedBodiesOrder,l=a.addBody,f=a.bodies,p=(t=r.useRef(0),n=r.useRef({}),o=r.useCallback((function(e){var r=t.current.toString();return t.current+=1,n.current[r]=e,function(){delete n.current[r]}}),[]),{onUpdate:r.useCallback((function(){Object.values(n.current).forEach((function(e){return e()}))}),[]),subscribeToPhysicsUpdates:o});return{subscribeToPhysicsUpdates:p.subscribeToPhysicsUpdates,getPendingSyncedBodiesIteration:u,syncedBodies:c,syncedBodiesOrder:d,addSyncedBody:i,removeSyncedBody:s,addBody:l,bodies:f,onUpdate:p.onUpdate}},ee=function(e){var t=e.children,n=e.world,a=e.worker,i=e.stepRate,s=e.maxNumberOfSyncedBodies,u=r.useCallback((function(e){n.destroyBody(e)}),[]),c=$(u),d=c.subscribeToPhysicsUpdates,l=c.getPendingSyncedBodiesIteration,f=c.syncedBodies,p=c.syncedBodiesOrder,y=c.addSyncedBody,v=c.removeSyncedBody,m=c.addBody,h=c.bodies,g=c.onUpdate,b=r.useMemo((function(){return{onWorldStep:function(){n.step(i/1e3),n.clearForces(),g()}}}),[]).onWorldStep;return o.createElement(T.Provider,{value:{getPendingSyncedBodiesIteration:l,syncedBodies:f,syncedBodiesOrder:p,maxNumberOfSyncedBodies:s}},o.createElement(H,{applyBufferData:J,generateBuffers:Z,worker:a,subscribe:d}),o.createElement(W.Provider,{value:{world:n,addSyncedBody:y,removeSyncedBody:v,addBody:m,bodies:h}},o.createElement(z,{world:n,worker:a}),o.createElement(F,{onWorldStep:b,stepRate:i},t)))},te=function(){var e=v();return u.useFrame(e.syncMeshes),null},ne=function(){var e=v().syncMeshes;return r.useEffect((function(){var t=setInterval((function(){e()}),1e3/30);return function(){clearInterval(t)}}),[]),null},re=function(e){var t=e.useRAF;return o.createElement(void 0!==t&&t?te:ne,null)},oe=r.createContext(null),ae=function(e){return o.createElement(oe.Provider,{value:{prepareObject:e.prepareObject}},e.children)},ie=function(e,t,n){var o=(null!=n?n:{}).applyRotation,i=void 0===o||o,s=v().syncBody;r.useLayoutEffect((function(){if(t)return t.current||(t.current=new a.Object3D),s(e,t,i)}),[t])},se=function(e,n,o){void 0===n&&(n={});var a=v().sendMessage,i=r.useState((function(){var e;return null!=(e=n.id)?e:x()}))[0],s=r.useRef(null),u=(r.useContext(oe)||{}).prepareObject,c=r.useState((function(){return n.ref||s}))[0];return ie(i,c),r.useLayoutEffect((function(){var r,s=e();return u&&u(c.current,s),a({type:t.ADD_BODY,data:g({id:i,props:s,synced:null==(r=n.synced)||r},o?o(s,n):{})}),function(){a({type:t.REMOVE_BODY,data:{id:i}})}}),[]),[c,i]},ue=function(e){var n=e.world,o=e.worker,a=q(),i=a.addBody,s=a.bodies,u=r.useMemo((function(){return{handleModifyBody:function(e){var t=e.id,n=s[t];n?n[e.method].apply(n,e.args):console.warn("No body found matching "+t)},handleAddBody:function(e){var t,r=e.id,o=e.props,a=e.synced,s=e.listenForCollisions,u=function(e,t){var n=new c.Body(t.body);return t.shapes.forEach((function(e){var t=e.args;switch(e.type){case"Box":var r=new c.Box(S(c.Vec3,t.map((function(e){return e/2}))));n.addShape(r);break;case"Sphere":var o=S(c.Sphere,t);n.addShape(o)}})),e.addBody(n),n}(n,o);u.userData=g({id:r},null!=(t=o.userData)?t:{}),i(r,u,a),s&&console.log("listenForCollisions")}}}),[]),d=u.handleAddBody,l=u.handleModifyBody;return r.useEffect((function(){var e=o.onmessage;o.onmessage=function(n){var r=n.data;switch(r.type){case t.ADD_BODY:d(r.data);break;case t.MODIFY_BODY:l(r.data)}e&&e(n)}}),[]),null},ce=function(e,t,n){var r=e.positions,o=e.angles;n.forEach((function(e,n){var a=t[e];if(a){var i=a.position,s=a.quaternion;r[3*n+0]=i.x,r[3*n+1]=i.y,r[3*n+2]=i.z,o[4*n+0]=s.x,o[4*n+1]=s.y,o[4*n+2]=s.z,o[4*n+3]=s.w}}))},de=new a.Quaternion,le=function(e,t,n){var r=e.position,o=e.angle,a=e.lastUpdate,i=e.previous;if(r&&o){var s,u;if(!i.position||!i.angle)return(s=t.position).set.apply(s,r),void(u=t.quaternion).set.apply(u,o);var c=(p()-a)/(a+n+1-a),d=c=c<0?0:c>1?1:c;t.position.x=G(i.position[0],r[0],d),t.position.y=G(i.position[1],r[1],d),t.position.z=G(i.position[2],r[2],d),t.quaternion.fromArray(i.angle),de.fromArray(o),t.quaternion.slerp(de,d)}},fe=function(e,t,n){e.previous.position=e.position,e.previous.angle=e.angle;var r=function(e,t){if(void 0!==t&&e.positions.length&&e.angles.length){var n=3*t,r=4*t;return{position:e.positions.slice(n,n+3),angle:e.angles.slice(r,r+4)}}return null}({positions:t,angles:n},e.index);r&&(e.position=r.position,e.angle=r.angle)},pe=function(e,t){var n,r;t.body.position&&(n=e.position).set.apply(n,t.body.position.toArray()),t.body.quaternion&&(r=e.quaternion).set.apply(r,t.body.quaternion.toArray())},ye=function(e){return{positions:new Float32Array(3*e),angles:new Float32Array(4*e)}},ve=function(e){var t=e.children,n=e.world,a=e.stepRate,i=e.worker,s=e.maxNumberOfSyncedBodies,u=r.useCallback((function(e){n.removeBody(e)}),[]),c=$(u),d=c.subscribeToPhysicsUpdates,l=c.getPendingSyncedBodiesIteration,f=c.syncedBodies,y=c.syncedBodiesOrder,v=c.addSyncedBody,m=c.removeSyncedBody,h=c.addBody,g=c.bodies,b=c.onUpdate,w=r.useRef({lastUpdate:p()}),S=r.useMemo((function(){return{onWorldStep:function(){var e=p(),t=(e-w.current.lastUpdate)/1e3;w.current.lastUpdate=e,n.step(a/1e3,t),b()}}}),[]).onWorldStep;return o.createElement(T.Provider,{value:{getPendingSyncedBodiesIteration:l,syncedBodies:f,syncedBodiesOrder:y,maxNumberOfSyncedBodies:s}},o.createElement(H,{applyBufferData:ce,generateBuffers:ye,worker:i,subscribe:d}),o.createElement(W.Provider,{value:{world:n,addSyncedBody:v,removeSyncedBody:m,addBody:h,bodies:g}},o.createElement(ue,{world:n,worker:i}),o.createElement(F,{onWorldStep:S,stepRate:a},t)))},me=function(e,t){var n={};return t.listenForCollisions&&(n.listenForCollisions=!0),n},he=(function(e){var t=function(e){var t=Object.prototype,n=t.hasOwnProperty,r="function"==typeof Symbol?Symbol:{},o=r.iterator||"@@iterator",a=r.asyncIterator||"@@asyncIterator",i=r.toStringTag||"@@toStringTag";function s(e,t,n){return Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{s({},"")}catch(e){s=function(e,t,n){return e[t]=n}}function u(e,t,n,r){var o=Object.create((t&&t.prototype instanceof l?t:l).prototype),a=new B(r||[]);return o._invoke=function(e,t,n){var r="suspendedStart";return function(o,a){if("executing"===r)throw new Error("Generator is already running");if("completed"===r){if("throw"===o)throw a;return{value:void 0,done:!0}}for(n.method=o,n.arg=a;;){var i=n.delegate;if(i){var s=w(i,n);if(s){if(s===d)continue;return s}}if("next"===n.method)n.sent=n._sent=n.arg;else if("throw"===n.method){if("suspendedStart"===r)throw r="completed",n.arg;n.dispatchException(n.arg)}else"return"===n.method&&n.abrupt("return",n.arg);r="executing";var u=c(e,t,n);if("normal"===u.type){if(r=n.done?"completed":"suspendedYield",u.arg===d)continue;return{value:u.arg,done:n.done}}"throw"===u.type&&(r="completed",n.method="throw",n.arg=u.arg)}}}(e,n,a),o}function c(e,t,n){try{return{type:"normal",arg:e.call(t,n)}}catch(e){return{type:"throw",arg:e}}}e.wrap=u;var d={};function l(){}function f(){}function p(){}var y={};y[o]=function(){return this};var v=Object.getPrototypeOf,m=v&&v(v(x([])));m&&m!==t&&n.call(m,o)&&(y=m);var h=p.prototype=l.prototype=Object.create(y);function g(e){["next","throw","return"].forEach((function(t){s(e,t,(function(e){return this._invoke(t,e)}))}))}function b(e,t){var r;this._invoke=function(o,a){function i(){return new t((function(r,i){!function r(o,a,i,s){var u=c(e[o],e,a);if("throw"!==u.type){var d=u.arg,l=d.value;return l&&"object"==typeof l&&n.call(l,"__await")?t.resolve(l.__await).then((function(e){r("next",e,i,s)}),(function(e){r("throw",e,i,s)})):t.resolve(l).then((function(e){d.value=e,i(d)}),(function(e){return r("throw",e,i,s)}))}s(u.arg)}(o,a,r,i)}))}return r=r?r.then(i,i):i()}}function w(e,t){var n=e.iterator[t.method];if(void 0===n){if(t.delegate=null,"throw"===t.method){if(e.iterator.return&&(t.method="return",t.arg=void 0,w(e,t),"throw"===t.method))return d;t.method="throw",t.arg=new TypeError("The iterator does not provide a 'throw' method")}return d}var r=c(n,e.iterator,t.arg);if("throw"===r.type)return t.method="throw",t.arg=r.arg,t.delegate=null,d;var o=r.arg;return o?o.done?(t[e.resultName]=o.value,t.next=e.nextLoc,"return"!==t.method&&(t.method="next",t.arg=void 0),t.delegate=null,d):o:(t.method="throw",t.arg=new TypeError("iterator result is not an object"),t.delegate=null,d)}function S(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function E(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function B(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(S,this),this.reset(!0)}function x(e){if(e){var t=e[o];if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var r=-1,a=function t(){for(;++r<e.length;)if(n.call(e,r))return t.value=e[r],t.done=!1,t;return t.value=void 0,t.done=!0,t};return a.next=a}}return{next:O}}function O(){return{value:void 0,done:!0}}return f.prototype=h.constructor=p,p.constructor=f,f.displayName=s(p,i,"GeneratorFunction"),e.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===f||"GeneratorFunction"===(t.displayName||t.name))},e.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,p):(e.__proto__=p,s(e,i,"GeneratorFunction")),e.prototype=Object.create(h),e},e.awrap=function(e){return{__await:e}},g(b.prototype),b.prototype[a]=function(){return this},e.AsyncIterator=b,e.async=function(t,n,r,o,a){void 0===a&&(a=Promise);var i=new b(u(t,n,r,o),a);return e.isGeneratorFunction(n)?i:i.next().then((function(e){return e.done?e.value:i.next()}))},g(h),s(h,i,"Generator"),h[o]=function(){return this},h.toString=function(){return"[object Generator]"},e.keys=function(e){var t=[];for(var n in e)t.push(n);return t.reverse(),function n(){for(;t.length;){var r=t.pop();if(r in e)return n.value=r,n.done=!1,n}return n.done=!0,n}},e.values=x,B.prototype={constructor:B,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(E),!e)for(var t in this)"t"===t.charAt(0)&&n.call(this,t)&&!isNaN(+t.slice(1))&&(this[t]=void 0)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var t=this;function r(n,r){return i.type="throw",i.arg=e,t.next=n,r&&(t.method="next",t.arg=void 0),!!r}for(var o=this.tryEntries.length-1;o>=0;--o){var a=this.tryEntries[o],i=a.completion;if("root"===a.tryLoc)return r("end");if(a.tryLoc<=this.prev){var s=n.call(a,"catchLoc"),u=n.call(a,"finallyLoc");if(s&&u){if(this.prev<a.catchLoc)return r(a.catchLoc,!0);if(this.prev<a.finallyLoc)return r(a.finallyLoc)}else if(s){if(this.prev<a.catchLoc)return r(a.catchLoc,!0)}else{if(!u)throw new Error("try statement without catch or finally");if(this.prev<a.finallyLoc)return r(a.finallyLoc)}}}},abrupt:function(e,t){for(var r=this.tryEntries.length-1;r>=0;--r){var o=this.tryEntries[r];if(o.tryLoc<=this.prev&&n.call(o,"finallyLoc")&&this.prev<o.finallyLoc){var a=o;break}}a&&("break"===e||"continue"===e)&&a.tryLoc<=t&&t<=a.finallyLoc&&(a=null);var i=a?a.completion:{};return i.type=e,i.arg=t,a?(this.method="next",this.next=a.finallyLoc,d):this.complete(i)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),d},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.finallyLoc===e)return this.complete(n.completion,n.afterLoc),E(n),d}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.tryLoc===e){var r=n.completion;if("throw"===r.type){var o=r.arg;E(n)}return o}}throw new Error("illegal catch attempt")},delegateYield:function(e,t,n){return this.delegate={iterator:x(e),resultName:t,nextLoc:n},"next"===this.method&&(this.arg=void 0),d}},e}(e.exports);try{regeneratorRuntime=t}catch(e){Function("r","regeneratorRuntime = r")(t)}}(K={exports:{}}),K.exports),ge=function(e,t,n){var r=e.positions,o=e.angles;n.forEach((function(e,n){var a=t[e];if(a){var i=a.translation(),s=a.rotation();r[3*n+0]=i.x,r[3*n+1]=i.y,r[3*n+2]=i.z,o[4*n+0]=s.x,o[4*n+1]=s.y,o[4*n+2]=s.z,o[4*n+3]=s.w}}))},be=function(e,t){var n,r;t.body.position&&(n=e.position).set.apply(n,t.body.position),t.body.quaternion&&(r=e.quaternion).set.apply(r,t.body.quaternion)},we=function(e,t){var n=new d.RigidBodyDesc(t.body.type);null!=t.body.mass&&n.setMass(t.body.mass),t.body.position&&n.setTranslation.apply(n,t.body.position),t.body.quaternion&&n.setRotation({x:t.body.quaternion[0],y:t.body.quaternion[1],z:t.body.quaternion[2],w:t.body.quaternion[3]});var r=e.createRigidBody(n);return t.colliders.forEach((function(t){!function(e,t,n){var r=function(e){switch(e.type){case"Ball":return d.ColliderDesc.ball.apply(d.ColliderDesc,e.args);case"Cubiod":return d.ColliderDesc.cuboid.apply(d.ColliderDesc,e.args)}return null}(n);r&&e.createCollider(r,t.handle)}(e,r,t)})),r},Se={customBodyModifiers:{}},Ee=function(e){var n=e.world,o=e.worker,a=q(),i=a.addBody,s=a.bodies,u=r.useRef({removeCallbacks:{}}),c=r.useMemo((function(){return{handleModifyBody:function(e){var t=e.id,n=s[t];n?n[e.method].apply(n,e.args):console.warn("No body found matching "+t)},handleAddBody:function(e){var t=e.id,r=e.props,o=e.synced,a=we(n,r),s=function(e){if(e.customBody&&Se.customBodyModifiers[e.customBody])return Se.customBodyModifiers[e.customBody]}(r);s&&s(a),u.current.removeCallbacks[t]=i(t,a,o)},handleRemoveBody:function(e){var t=e.id;n.removeRigidBody(s[t]),u.current.removeCallbacks[t]&&u.current.removeCallbacks[t]()}}}),[]),d=c.handleAddBody,l=c.handleModifyBody,f=c.handleRemoveBody;return r.useEffect((function(){var e=o.onmessage;o.onmessage=function(n){var r=n.data;switch(r.type){case t.ADD_BODY:d(r.data);break;case t.REMOVE_BODY:f(r.data);break;case t.MODIFY_BODY:l(r.data)}e&&e(n)}}),[]),null},Be=function(e){var t=e.children,n=e.world,a=e.stepRate,i=e.worker,s=e.maxNumberOfSyncedBodies,u=r.useCallback((function(e){!function(e,t){e.removeRigidBody(t)}(n,e)}),[]),c=$(u),d=c.subscribeToPhysicsUpdates,l=c.getPendingSyncedBodiesIteration,f=c.syncedBodies,p=c.syncedBodiesOrder,y=c.addSyncedBody,v=c.removeSyncedBody,m=c.addBody,h=c.bodies,g=c.onUpdate,b=r.useState(!1),w=b[0],S=b[1],E=r.useMemo((function(){return{onWorldStep:function(){w||(n.step(),g())}}}),[w]).onWorldStep;return o.createElement(T.Provider,{value:{getPendingSyncedBodiesIteration:l,syncedBodies:f,syncedBodiesOrder:p,maxNumberOfSyncedBodies:s}},o.createElement(H,{applyBufferData:ge,generateBuffers:ye,worker:i,subscribe:d,setPaused:S}),o.createElement(W.Provider,{value:{world:n,addSyncedBody:y,removeSyncedBody:v,addBody:m,bodies:h}},o.createElement(Ee,{world:n,worker:i}),o.createElement(F,{onWorldStep:E,stepRate:a},t)))};exports.CannonApp=function(e){var t=e.children,n=e.stepRate,a=void 0===n?1e3/60:n,i=e.maxNumberOfSyncedBodies,s=void 0===i?100:i,u=e.worker,d=function(){var e=r.useState(null),t=e[0],n=e[1];return r.useEffect((function(){var e=new c.World;e.gravity.set(0,-9.81,0),n(e),e.addEventListener("beginContact",(function(){})),e.addEventListener("endContact",(function(){}))}),[]),{world:t}}().world;return d?o.createElement(_,{worker:u},o.createElement(ve,{world:d,worker:u,stepRate:a,maxNumberOfSyncedBodies:s},t)):null},exports.CannonPhysicsConsumer=function(e){return o.createElement(Y,{updateBodyData:fe,lerpBody:le,worker:e.worker,stepRate:e.stepRate},o.createElement(ae,{prepareObject:pe},e.children))},exports.Physics=F,exports.PhysicsConsumer=Y,exports.PhysicsConsumerSyncMeshes=re,exports.PlanckApp=function(e){var t=e.children,n=e.stepRate,a=void 0===n?1e3/60:n,i=e.maxNumberOfSyncedBodies,u=void 0===i?100:i,c=e.worker,d=function(){var e=r.useState(null),t=e[0],n=e[1];return r.useEffect((function(){var e=new s.World({allowSleep:!1});n(e)}),[]),{world:t}}().world;return d?o.createElement(_,{worker:c},o.createElement(ee,{world:d,worker:c,stepRate:a,maxNumberOfSyncedBodies:u},t)):null},exports.PlanckPhysicsConsumer=function(e){return o.createElement(Y,{updateBodyData:Q,lerpBody:V,worker:e.worker,stepRate:e.stepRate},o.createElement(ae,{prepareObject:X},e.children))},exports.Rapier3DApp=function(e){var t=e.children,n=e.stepRate,a=void 0===n?1e3/60:n,i=e.maxNumberOfSyncedBodies,s=void 0===i?100:i,u=e.customBodyModifiers,c=void 0===u?{}:u,l=e.worker,f=function(e){var t=r.useState(null),n=t[0],o=t[1],a=r.useCallback(h(he.mark((function t(){var n,r;return he.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,d.init();case 2:n=new d.Vector3(0,-9.81,0),(r=new d.World(n)).timestep=e/1e3,o(r);case 6:case"end":return t.stop()}}),t)}))),[]);return r.useEffect((function(){a()}),[]),{world:n}}(a).world;return r.useEffect((function(){Se.customBodyModifiers=c}),[c]),f?o.createElement(_,{worker:l},o.createElement(Be,{world:f,worker:l,stepRate:a,maxNumberOfSyncedBodies:s},t)):null},exports.Rapier3DPhysicsConsumer=function(e){var t=e.children,n=E(e,["children"]);return o.createElement(Y,Object.assign({updateBodyData:fe,lerpBody:le},n),o.createElement(ae,{prepareObject:be},t))},exports.SyncComponents=function(e){var n=e.components,a=r.useContext(R).worker,i=r.useState({}),s=i[0],u=i[1],c=r.useCallback((function(e){var t=e.id,n=e.type,r=e.value,o=e.propKey;switch(e.message){case B.mounted:u((function(e){var o;return g({},e,((o={})[t]={id:t,type:n,props:r},o))}));break;case B.unmounted:u((function(e){var n=g({},e);return delete n[t],n}));break;case B.propUpdate:u((function(e){var n,a,i,s=null!=(n=e[t])?n:{props:{}};return g({},e,((i={})[t]=g({},s,{props:g({},s.props,(a={},a[o]=r,a))}),i))}));break;case B.propRemoved:u((function(e){var n,r,a=null!=(n=e[t])?n:{props:{}},i=g({},a.props);return delete i[o],g({},e,((r={})[t]=g({},a,{props:i}),r))}))}}),[]);return r.useEffect((function(){var e=a.onmessage;return a.onmessage=function(n){e&&e(n);var r=n.data;r.type===t.CUSTOM&&c(r.message)},function(){a.onmessage=e}}),[]),o.createElement(o.Fragment,null,Object.entries(s).map((function(e){var t=e[0],r=e[1],a=n[r.type];return a?o.createElement(a,Object.assign({id:t},r.props,{key:t})):null})))},exports.SyncedComponent=function(e){var t=e.type,n=e.id,a=E(e,["type","id"]),i=r.useContext(R).sendMessage,s=r.useState((function(){return null!=n?n:x()}))[0];return function(e,t,n,o){r.useEffect((function(){return o({message:B.mounted,id:t,type:e,value:n}),function(){o({message:B.unmounted,id:t})}}),[e,t,o])}(t,s,a,i),o.createElement(o.Fragment,null,Object.entries(a).map((function(e){var t=e[0];return o.createElement(D,{key:t,id:s,propKey:t,value:e[1],sendMessage:i})})))},exports.createBody=we,exports.createWorkerApp=function(e){n.render(r.createElement(e,{worker:self}),null)},exports.rawActiveKeys=C,exports.useActiveKeys=O,exports.useBodyApi=function(e){var n=v().sendMessage;return r.useCallback((function(r,o){n({type:t.MODIFY_BODY,data:{id:e,method:r,args:o}})}),[])},exports.useCannonBody=function(e,t){return void 0===t&&(t={}),se(e,t,me)},exports.useOnFixedUpdate=function(e){var t=U().subscribeToOnPhysicsUpdate,n=r.useRef(e);r.useEffect((function(){n.current=e}),[e]),r.useEffect((function(){return t(n)}),[])},exports.usePhysicsConsumerContext=v,exports.usePlanckAppContext=q,exports.usePlanckBody=function(e,t){return void 0===t&&(t={}),se(e,t)},exports.useRapier3DBody=function(e,t){return void 0===t&&(t={}),se(e,t,me)},exports.useSyncBody=ie;
//# sourceMappingURL=rgg-engine.cjs.production.min.js.map
